define(["require","exports","tslib","classnames","react","react-redux","dig-components/buttons","dig-components/menu","spectrum/button","spectrum/tooltip","modules/clean/file_store/utils","modules/clean/integrations/data/selectors","modules/clean/react/app_actions/apis","modules/clean/react/app_actions/shared_file_popover_content_component","modules/clean/react/app_actions/telemetry_client","modules/clean/react/css","modules/clean/react/extensions/data/action_creators","modules/clean/react/extensions/data/helpers","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/data/types","modules/clean/react/extensions/extensions_popover_content_component_v2","modules/clean/react/extensions/extensions_utils","modules/clean/react/extensions/file","modules/clean/react/extensions/tooltips","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/open_button/types","modules/clean/react/file_viewer/unity/with_unity","modules/clean/react/file_viewer_sidebar/buttons/icon","modules/constants/file_viewer","modules/core/i18n"],(function(e,t,n,o,r,i,s,a,l,p,c,u,d,g,f,m,h,_,v,y,S,T,I,C,w,E,x,P,O,B,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),r=n.__importDefault(r);var A="TOOLTIP_ONLY"===B.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES,D="COPY_AND_TOOLTIP"===B.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES,F=(function(e){function i(o){var i=e.call(this,o)||this;return i.handleButtonClick=function(e){e.preventDefault(),e.stopPropagation()},i.handleMenuClick=function(e){e.preventDefault(),e.stopPropagation()},i.handleHover=function(){i.currentSession&&i.currentSession.event("trigger_hover")},i.setBigTooltip=function(e){return n.__awaiter(i,void 0,void 0,(function(){var t,o,r,i,s,a,l,p,c;return n.__generator(this,(function(n){switch(n.label){case 0:return t=this.props,o=t.file,r=t.appActions,i=t.featureFlags,s=I.getFileExt(o)||"",(a=r.length>0)?[4,d.getTooltipHistory(e,["open_with_edu"])]:[3,2];case 1:l=n.sent(),p=C.allowedTooltips(a,s,i),c=p.find((function(e){return void 0!==l[e]&&!l[e]})),this.setState({bigTooltipName:c}),n.label=2;case 2:return[2]}}))}))},i.markBigTooltipViewed=function(){var e=!1,t=[];i.state.bigTooltipName&&(t.push(d.markTooltipViewed(i.props.user.id,i.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then((function(){i.props.showBigTooltip&&i.setBigTooltip(i.props.user.id)})),i.setState({bigTooltipName:void 0}))},i.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),i.props.onExtensionClick&&i.props.onExtensionClick(e.actionName||e.userAction),i.logToPreviews(e,!1),t.stopPropagation()},i.logToPreviews=function(e,t){if(i.props.telemetryContext&&"previews"===i.props.telemetryContext.surface&&e.userAction){var n=t?w.UserActionContext.TitleBarMain:w.UserActionContext.TitleBarSplitButton,o=e.actionName?{app_action_name:e.actionName}:{};c.isBrowseFile(i.props.file)&&i.props.file.read_only&&(o.readOnly=!0),E.logUserAction(e.userAction,n,o)}},i.renderTrigger=function(e){var t=null;switch(i.props.triggerType){case y.TriggerType.OpacityButton:t=r.default.createElement(s.Button,n.__assign({variant:"opacity",withDropdownIcon:!0},e),i.renderTriggerButtonContent(!0));break;default:t=r.default.createElement(l.Button,n.__assign({className:"app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",variant:i.props.triggerType===y.TriggerType.SecondaryButton||i.props.triggerType===y.TriggerType.CollapsedButton?"secondary":"primary"},e),i.renderTriggerButtonContent())}return r.default.createElement("div",n.__assign({onMouseDown:i.markBigTooltipViewed,onMouseEnter:i.handleHover},e),t)},i.renderMenu=function(){return r.default.createElement(a.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:i.handleSelectAction,onToggle:i.onPopoverToggle,isPortaled:!0},(function(e){var o=e.getContentProps,s=e.getTriggerProps;return r.default.createElement(r.default.Fragment,null,i.renderTrigger(s({onClick:i.handleButtonClick})),r.default.createElement(a.Menu.Content,n.__assign({},o({}),{onClick:i.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),r.default.createElement(t.ExtensionsPopoverContent,{user:i.props.user,file:i.props.file,unityInfo:i.props.unityInfo,extraOptions:i.props.extraOptions,sharingServiceInfo:i.props.sharingServiceInfo,refreshSharingServiceInfo:i.props.refreshSharingServiceInfo,onPresentInZoom:i.props.onPresentInZoom,currentSession:i.currentSession,telemetryContext:i.props.telemetryContext})))}))},i.onPopoverToggle=function(e){var t=e.isOpen;t&&i.props.onDropdownOpen?i.props.onDropdownOpen():!t&&i.props.onDropdownClose&&i.props.onDropdownClose(),i.currentSession&&i.currentSession.event(t?"open_popover":"close_popover")},i.onDownloadClick=function(e){return function(t){t.preventDefault(),t.stopPropagation(),e.handler(),i.logToPreviews(e,!0)}},i.state={},i.telemetryClient=f.createTelemetryClient({component:"menu_v2"}),i}return n.__extends(i,e),i.prototype.componentDidMount=function(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)},i.prototype.triggerText=function(){return b.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"})},i.prototype.renderTriggerButtonContent=function(e){var t=this.triggerText();if(this.props.triggerType===y.TriggerType.CollapsedButton){var n=r.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content"},r.default.createElement(O.ButtonIcon,{name:"open","aria-label":t}));return(A||D)&&this.props.triggerType===y.TriggerType.CollapsedButton?r.default.createElement(p.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:b.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},n):n}return e?t:r.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},r.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},t+" â–¾"))},i.prototype.render=function(){var e=this.props,t=e.file,n=e.appActions,i=e.featureFlags,s=e.isInFVSidebar,a=e.telemetryContext,p=e.triggerType,u=e.showAsButtonIfDownloadOnly,d=e.hasOpenInPaperSupport,g=e.unityInfo,m=e.extraOptions,h=e.user,v=e.sharingServiceInfo,S=e.refreshSharingServiceInfo,C=e.onPresentInZoom,w=e.landingPagesEnabled,E=e.cloudDocsInfo;if(!t.file_id)return null;a?this.currentSession=this.telemetryClient.session({surface:a.surface,ext:f.getPiiSafeExtension(I.getFileExt(t)||""),feature_flags:i}):delete this.currentSession;var P=T.getOpenOptionsForFile({file:t,hasOpenInPaperSupport:d,unityInfo:g,extraOptions:m,user:h,sharingServiceInfo:v,refreshSharingServiceInfo:S,onPresentInZoom:C,landingPagesEnabled:w,isCloudEditorDisabled:!0,cloudDocsInfo:E,surface:null==a?void 0:a.surface}),B=p===y.TriggerType.CollapsedButton,A=P.length>0,D=!1;if(A&&1===P.length&&(A=!(D=P[0].type===x.OpenButtonAction.DOWNLOAD)),!A&&(0===n.length||c.isSharedFile(t)&&0===_.partitionActions(n).cloudEditors.length)){if(u&&D){var F=p===y.TriggerType.SecondaryButton||B?"secondary":"primary",M=B||s&&"secondary"===F;return r.default.createElement(l.Button,{className:o.default("app-actions-download-button",{"app-actions-download-button--collapsed":M}),variant:F,onClick:this.onDownloadClick(P[0])},M?r.default.createElement(O.ButtonIcon,{name:"download-file",isPrimary:"primary"===F,"aria-label":b.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})}):b.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()},i.defaultProps={showAsButtonIfDownloadOnly:!1,triggerType:y.TriggerType.SecondaryButton},i})(r.default.Component);t.ExtensionsMenuV2Component=F;var M=function(e,t){return{appActions:v.getOpenActionsForFile(e,t.file),bylines:v.getBylines(e),categoryInfos:v.getCategoryInfos(e),featureFlags:v.getFeatureFlags(e),cloudDocsInfo:v.getCloudDocInfo(e),landingPagesEnabled:u.isConnectServiceLandingPagesEnabled(e)}},k={updateLinkState:function(e,t){return h.updateLinkState({actionId:e,linkState:t})},refreshSharingServiceInfo:h.refreshSharingServiceInfoAdapter},N=i.connect(M,k)(F);t.ExtensionsMenuV2NoUnity=m.requireCssWithComponent(N,["/static/css/app_actions/index-vflWo59zK.css","/static/css/dig-components/index.web-vflf6uHPG.css"]);var L=i.connect(M,k)((function(e){return c.isBrowseFile(e.file)?r.default.createElement(P.WithUnity,{file:e.file,user:e.user,render:function(t){return r.default.createElement(F,n.__assign({},e,{unityInfo:t}))}}):r.default.createElement(F,n.__assign({},e))}));t.ExtensionsMenuV2=m.requireCssWithComponent(L,["/static/css/app_actions/index-vflWo59zK.css","/static/css/dig-components/index.web-vflf6uHPG.css"]);t.ExtensionsPopoverContent=i.connect(M,k)((function(e){var t=e.file,n=e.user,o=e.telemetryContext,i=e.appActions,s=e.bylines,a=e.categoryInfos,l=e.featureFlags,p=e.updateLinkState,u=e.hasOpenInPaperSupport,d=e.unityInfo,m=e.extraOptions,h=e.sharingServiceInfo,v=e.refreshSharingServiceInfo,y=e.onPresentInZoom,C=e.landingPagesEnabled,w=e.cloudDocsInfo,E=e.isInActionBar,x=e.previewActionHandler,P=T.getCategoryIdToInfos(a),O=T.getOpenOptionsForFile({file:t,hasOpenInPaperSupport:u,unityInfo:d,extraOptions:m,user:n,sharingServiceInfo:h,refreshSharingServiceInfo:v,onPresentInZoom:y,landingPagesEnabled:C,isCloudEditorDisabled:!0,cloudDocsInfo:w,surface:null==o?void 0:o.surface,shouldUseShortUnityText:E,previewActionHandler:x}),B=o&&(e.currentSession||f.createTelemetryClient({component:"menu_v2"}).session({surface:o.surface,ext:f.getPiiSafeExtension(I.getFileExt(t)||""),feature_flags:l}));if(c.isBrowseFile(t)&&(i.length>0||O.length>0))return r.default.createElement(S.ExtensionsPopoverV2WithUnity,{file:t,user:n,openOptions:O,appActions:i,bylines:s,categoryIdToInfos:P,featureFlags:l,updateLinkState:p,telemetryContext:o,currentSession:B,isInActionBar:E});if(c.isSharedFile(t)){var b=_.partitionActions(i).cloudEditors;return r.default.createElement(g.SharedFilePopoverContent,{openOptions:O,cloudEditorAppActions:b,file:t,user:n,currentSession:B})}return null}))}));
//# sourceMappingURL=extensions_menu_component_v2.min.js-vflUoyZ8f.map